<!DOCTYPE html>
<html lang="en-US">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <base href="https://vsatresq.com/">
    <link rel="stylesheet" href="node_modules/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="css/main.css">
    <link rel="icon" type="image/png" href="./favicon.ico" />
    <script src="node_modules/jquery/dist/jquery.js"></script>
    <script src="/scripts/selfserve.js"></script>
    <script src="/scripts/random_banner.js"></script>
    <script src="/scripts/logintext_handler.js"></script>
    <!--TODO: can i make this better at all? 4 scripts???-->
    <title>VSAT ResQ</title>
</head>

<body>
    <header class="jumbotron">
        <div class="container-fluid">
            <div class="row">
                <div class="logo-container align-items-center">
                    <img class="logo-img" src="/images/new_logo.png">
                </div>
                <div class="drop_shadow w-100">
                    <nav class="navbar navbar-expand-md navbar-dark bg-dark w-100">
                        <button class="navbar-toggler" type="button" data-toggle="collapse"
                            data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent"
                            aria-expanded="false" aria-label="Toggle navigation">
                            <span class="navbar-toggler-icon"></span>
                        </button>
                        <div class="collapse navbar-collapse" id="navbarSupportedContent">
                            <ul class="navbar-nav mr-auto">
                                <li class="nav-item" id="nav-home">
                                    <a class="nav-link" href="./index.html">Home <span
                                            class="sr-only">(current)</span></a>
                                </li>
                                <li class="nav-item" id="nav-blog">
                                    <a class="nav-link" href="./blog">Blog</a>
                                </li>
                                <li class="nav-item" id="nav-pastjobs"><a class="nav-link"
                                        href="./PastJobs.html">Jobs</a></li>
                                <li class="nav-item" id="nav-about"><a class="nav-link" href="./AboutUs.html">About</a>
                                </li>
                                <li class="nav-item dropdown ">
                                    <!--.disabled-->
                                    <a class="nav-link dropdown-toggle" id="login-text" role="button"
                                        data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                        Login
                                    </a>
                                    <!--TODO: fix all these links and make them non-relative. -->
                                    <div class="dropdown-menu" aria-labelledby="login-text">
                                        <a class="dropdown-item authorized-only" id="nav-ucp" href="./blog/ucp">User
                                            Settings</a>
                                        <a class="dropdown-item authorized-only" id="nav-inventory" href="/inventory">Inventory (Beta)</a>
                                        <div class="dropdown-divider authorized-only"></div>
                                        <a class="dropdown-item" href="./blog/login" id="nav-login">Login</a>
                                    </div>
                                </li>
                                <li class="nav-item dropdown">
                                    <a class="nav-link dropdown-toggle" href="#" id="contact-us" role="button"
                                        data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                        Contact
                                    </a>
                                    <div class="dropdown-menu" aria-labelledby="contact-us">
                                        <a class="dropdown-item" href="mailto:dispatch@vsatresq.com">Email</a>
                                        <a class="dropdown-item" href="tel:+13867471525">Phone</a>
                                        <a class="dropdown-item" href="https://www.facebook.com/VsatResQ/">Facebook</a>
                                        </a>
                                </li>
                            </ul>
                        </div>
                    </nav>
                </div>
            </div>
        </div>
    </header>

    <div class="container h-100" id='fluidify-me'>
        <div class="row h-100 align-items-center">
            <div id="maincontentarea" class="main_content_area h-100">
                <!-- ---
layout: "inv_template"
--- -->
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0' />

<link rel="stylesheet" href="/css/jquery-ui.css">
<script src="/scripts/jquery-ui.js"></script>

<link rel="stylesheet" href="/css/inventory.css">
<script src="/scripts/selfserve_inventory.js"></script>

<link rel="stylesheet" href="/scripts/image-picker/image-picker.css">
<script src="/scripts/image-picker/image-picker.js"></script>

<script src="/scripts/quagga/quagga.js"></script>
<script src="/scripts/existing_images.js"></script>
<script src="/scripts/inventory_ui.js"></script>

<script>
    var __FLUIDIFY = true;

    const filterToUniqueItems = () => {
        var unique = [];

        unique = selfserve.inventory.db.filter((thing, index, self) => {
            thing.value = thing.item_name;

            return (self.findIndex((obj) => {
                return obj.item_name.toLowerCase() === thing.item_name.toLowerCase();
            })) === index;
        });

        console.log(unique);

        return unique;
    };

    const getItemBySerialNumber = (serial_number) => {
        for (let i = 0; i < selfserve.inventory.db.length; i++) {
            if (selfserve.inventory.db[i] !== undefined) {
                let itemCheck = selfserve.inventory.db[i];

                if (itemCheck.serial_number.trim()) {
                    if (itemCheck.serial_number.trim().toLowerCase() === serial_number.trim().toLowerCase()) return itemCheck;
                }
                else continue;
            }
            continue;
        }

        return undefined;
    };

    var timeout;

    const delayedSerialSearch = (serial_number) => {
        if (serial_number.length > 3) { }

        timeout = setTimeout(() => {
            let foundItem = getItemBySerialNumber(serial_number);
            if (foundItem === undefined) {
                // No existing matches, we're good to go!
                $("#new_item_serial").css('border-color', 'green');

                $("#item_exists_warning").hide();
                $("#item_exists_warning").html('');
            }
            else {
                // TODO: alert the user
                $("#new_item_serial").css('border-color', 'red');

                $("#item_exists_warning").show();
                $("#item_exists_warning").html(`<a href='/inventory/viewitem.html?id=${foundItem._id}&subdb=${selfserve.inventory.subdb}'>The item already exists.</a> You may want to add a note to it instead.`);
            }
        }, 500);
    };

    const reinitAutocomplete = () => {
        testtttting.source = filterToUniqueItems();
        // testtttting.source = selfserve.inventory.db;
        
        $("#new_item_name").autocomplete(testtttting).autocomplete("instance")._renderItem = function (ul, item) {
            return $("<li>")
                .append("<div>" + item.item_name + "<br>" + `<span style='color: grey;'>${item.description}</span>` + "</div>")
                .appendTo(ul);
        };
    };

    let testtttting = undefined;
    selfserve.inventory.initErrorFn = (msg) => {
        $("#inventory_container").hide();
        $("#inventory_error_msg").append(`<span>${msg}</span>`);
        $("#inventory_error_msg").show();
    };

    selfserve.inventory.initCompleteFn = () => {
        // $("#peek").text(JSON.stringify(selfserve.inventory.db));

        testtttting = {
            minLength: 0,
            source: selfserve.inventory.db,
            focus: (event, ui) => {
                $("#new_item_name").val( ui.item.label );
                return false;
            },
            select: (event, ui) => {
                $("#new_item_name").val(ui.item.item_name);
                $("#new_item_description").val(ui.item.description);

                ui.item.images.forEach((image_url, index) => {
                    let preview = createImgPreview(image_url);
                    $("#upload_preview").append(preview);
                });

                return false;
            }
        };

        $("#subdb_select").change((eventData) => {
            let newSubDbName = $("#subdb_select option:selected").val();
            let params = {subdb: newSubDbName};
            
            window.history.pushState(newSubDbName, `${newSubDbName} Inventory - VSAT ResQ`, `/inventory/?subdb=${newSubDbName}`);

            subdbSelectionChanged(newSubDbName);
        });

        $("#new_item_serial").keyup(() => {
            if(selfserve_inventory_editing) return;

            if ($("#new_item_serial").val().trim()) {
                delayedSerialSearch($("#new_item_serial").val());
            }
            else {
                $("#new_item_serial").css('border-color', 'red');
                $("#item_exists_warning").hide('');
            }
        });

        $("#new_item_serial").change(() => {
            if ($("#new_item_serial").val().trim().length > 5) {
                delayedSerialSearch($("#new_item_serial").val());
            }
            else {
                $("#new_item_serial").css('border-color', 'red');
                $("#item_exists_warning").hide();
            }
        });

        populateOptionsWithSubDBs(() => {

            let url_parameter = selfserve.auth.getUrlParameter('subdb');
            

            let potentialDbName = $("#subdb_select option:selected").val();

            if(url_parameter) 
            {
                potentialDbName = url_parameter;

                $("#subdb_select").val(url_parameter);
            }


            if (potentialDbName !== undefined && potentialDbName !== "undefined" && potentialDbName !== "new_subdb") {
                selfserve.inventory.subdb = potentialDbName;
                populateItemsFromSubdb(undefined);
            }
        });
    };
</script>

<div id="inventory_error_msg" style="display: none;">
    <h2>Error</h2>

</div>

<div id="inventory_container" style='padding: 1%;'>
    <navbar class="custom_nav round_corners drop_shadow give_me_space">
        <a href="/inventory">
            <div class="shop_home">
                <img src="/images/icons/home.png" class="cart_icon">
                <!-- <span class="tooltiptext">Inventory Home</span> -->
            </div>
        </a>
        <a href="javascript:void(0);" onclick="resetNewItemOverlay(); showNewItemOverlay();">
            <div class="cart">
                <img src="/images/icons/add.png" class="cart_icon">
                <!-- <span class="tooltiptext">Add Item to Subdatabase</span> -->
            </div>
        </a>
        <a href="#" id="shop_cp_icon" style="display: none;">
            <div class="cart">
                <img src="/images/icons/cp.png" class="cart_icon">
                <!-- <span class="tooltiptext">Inventory Control Panel</span> -->
            </div>
        </a>
        <p> </p>
        <div id="subdb_selection">
            Subdatabase:
            <select id="subdb_select">
            </select>
        </div>
    </navbar>

    <div id="new_subdb_overlay" class="overlay">
        <div id="item_editor_container" data-edit_id="undefined">
            <h2 id="overlay_header">Create new subdatabase</h2>
            <form onsubmit="return validateForm()" id="new_item_form">
                <p id='item_id' style='display: hidden'></p>
                Subdatabase Name (no spaces):<br>
                <input autocomplete="off" type="text" name="subdb_name" id="new_subdb_name" class="fullwidth"><br>
                <input type="button" value="Create subdatabase" onclick="submitNewSubdb($('#new_subdb_name').val());">
                <input type="button" value="Cancel" onclick="hideNewSubdbOverlay();">
            </form>
        </div>
    </div>

    <div id="new_item_overlay" class="overlay">
        <div id="item_editor_container" data-edit_id="undefined">
            <h2 id="new_item_overlay_header">New Item</h2>
            <form onsubmit="return validateForm()" id="new_item_form">
                <p id="new_item_id" style='display: hidden'></p>
                Item Name:<br>
                <input autocomplete="off" name="itemSearchTerm" id="new_item_name" class="fullwidth"><br><br>
                Serial Number:<br>
                <!--<input type="text" name="item_serial_number" id="new_item_serial" class="fullwidth">-->
                <div class="input-field">
                    <!--<label for="new_item_serial">EAN:</label>-->
                    <input id="new_item_serial" class="isbn" type="text" />
                    <button type="button" class="icon-barcode button scan">Scan</button><br>
                    <span id="item_exists_warning"></span>
                </div>
                <br><br>
                Description (optional):<br>
                <input type="text" name="item_description" id="new_item_description" class="fullwidth"><br><br>
                Select images: <input type="file" name="img" multiple onchange="handleFiles(this.files)"><br>
                <div id="upload_preview"></div>
                <a href="javascript:void(0);" onclick="showExistingImagesOverlay();">Use existing image(s)</a><br>
                <input type="button" id="add_new_item_button" value="Add Item" onclick="submitNewItem();">
                <input type="button" value="Cancel" onclick="hideNewItemOverlay();">
            </form>
        </div>
    </div>

    <div id="existing_images_overlay" class="overlay">
        <div id="item_editor_container">
            <input type="button" value="Test Load" onclick="populateExistingImagesList();">
            <h2>Existing Images</h2>

            <input type="button" value="Confirm Selection" onclick="confirmExistingImagesSelection();">
            <input type="button" value="Cancel" onclick="hideExistingImagesOverlay();">
            <div id="dummy_scroll_container">
                <select id="existing_images_select" multiple="multiple" class="image-picker"></select>
            </div>
        </div>
    </div>


    <div id="welcome_message">
        Tap the name of any item to view detailed notes about that item.
    </div>



    <div style='height: 100%' id="db_container">
        <!--<textarea style='min-width: 70%; height: auto;' id='peek'></textarea>-->
        <br>
        <table id="datatable" style='background-color: #343434; table-layout: fixed; width: 100%'>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Description</th>
                <th>Price</th>
                <th>Image</th>
            </tr>
        </table>

    </div>
</div>

<script src="/scripts/use_barcode.js"></script>
            </div>
            <!--
            <div id="sidenav" class="col-2 d-none d-md-block h-100">
                <h3>Recent Blog Posts</h3>
                <script>
                    $.get( "/blog/getpost?limit=5", function( data ) {
                        var resultingPosts = JSON.parse(data);
                        resultingPosts.posts.sort(function(a, b){
                            return b.date - a.date;
                        });
                        resultingPosts.posts.forEach(element => {
                            var div = $("<div>").attr('id', 'sidenav-post');
                            var sidenav = $("#sidenav");
                            div.html(`<a href="/blog/viewpost?id=${element.id}">${element.title}</a><br>${element.author} - ${element.date}<hr>`);
                            sidenav.append(div);
                        });
                    });
                </script>
            </div>
            -->
        </div>
    </div>
    <script>
        try
        {
            if(__FLUIDIFY)
            {
                console.log('Must fluidify.');
                $("#fluidify-me").removeClass('container');
                $("#fluidify-me").addClass('container-fluid');
            }
        } catch(e) {}
    </script>

    <script src="node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
</body>

</html>