<!DOCTYPE html>
<html lang="en-US">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <base href="https://vsatresq.com/"><!--TODO: change this or make it a variable?-->
  <link rel="stylesheet" href="/css/new_main.css">

  <!--Two essential scripts and one non-essential but still fun.-->
  <script src="node_modules/jquery/dist/jquery.js"></script>
  <script src="/scripts/selfserve.js"></script>
  <script src="/scripts/random_banner.js"></script>
  <script src="/scripts/logintext_handler.js"></script> <!--TODO: can i make this better at all? 4 scripts???-->
</head>

<body>
  <div class="wrapper">
    <div class="header_container">
      <div class="selfserve_login_text"><a href="./blog/ucp/">Hide this when not logged in</a></div>
      <div class="header_logo_container"><a href="./"><img class="header_logo" src="images/logo.svg"></a></div>
      <div class="header_logo_text_container"><h1 class="header_logo_text">PSYCH CAT</h1></div>
    </div>

    <navbar class="custom_nav">
      <a href="./bio">Bio</a>
      <a href="./blog">Updates</a>
      <a href="./shop">Shop</a>
      <div class="dropdown">
          <a class="droptoggle" href="#">Gallery</a>
          <div class="dropdown-content">
            <a href="./gallery/past">Past Events</a>
            <a href="./gallery/artists">Artists</a>
            <a href="./gallery/musicians">Musicians</a>
          </div>
      </div>
      <!--<a href="./music">Music</a>-->
      <!--<a href="./shop">Shop</a>-->
      <div class="dropdown">
          <a class="droptoggle" href="#">Contact</a>
          <div class="dropdown-content">
            <a href="https://instagram.com/psych.cat/">Instagram</a>
            <a href="https://www.facebook.com/psychcat/">Facebook</a>
            <a href="mailto:psychcat666@gmail.com">Email</a>
          </div>
      </div>

      <div id="current_user_message" class="right-align">
        <a href="./auth/ucp"><img src='/images/user.png' style='max-width: 60%; height: auto;'></a>
      </div>
    </navbar>

    <div class="main_content_area">
      <style>
    .registration_successful {
        display: none;
    }

    .registration_failed {
        display: none;
    }
</style>

<script>

    document.title = "Register - Psych Cat"

    const setRegisterFormVisible = (visible) => (visible ? $("#registration_form").show() : $("#registration_form").hide());

    const registrationSuccessful = () => {
        setRegisterFormVisible(false);
        $(".registration_successful").css("display", "block");
    };

    const registrationFailed = (failMessage) => {
        console.log('registeration FAILED', failMessage);

        setRegisterFormVisible(false);
        $(".registration_failed").find("#cause").html(failMessage);
        $(".registration_failed").css("display", "block");
    }

    const validateEmail = (email) => {
        var re = /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
        return re.test(email);
    }

    const validation = () => {
        const _email = $("#email_textbox").val();
        const _username = $("#username_textbox").val();
        const _password = $("#password_textbox").val();

        if (validateEmail(_email) && _username && _password) {
            registerButtonClick();
            return true;
        }
        else {
            showBad();
            //alert('Invalid data');
            return false;
        }
    };

    const showBad = () => {
        const _email = $("#email_textbox").val();
        const _username = $("#username_textbox").val();
        const _password = $("#password_textbox").val();

        if (!validateEmail(_email)) $("#email_textbox").css("border-color", "red");

        if (!_username) $("#username_textbox").css("border-color", "red");
        if (!_password) $("#password_textbox").css("border-color", "red");
    }

    const registerButtonClick = () => {
        const _email = $("#email_textbox").val();
        const _username = $("#username_textbox").val();
        const _password = $("#password_textbox").val();

        selfserve.auth.registerAccount(_email, _username, _password, (r, s, xhr) => {
            if (s === "success") {
                registrationSuccessful();
                selfserve.auth.loginAs(_username, _password, true, (user_loggedin_as) => {
                    if (user_loggedin_as.err) {
                        alert('Post-registration login failed. Please contact the system administrator.', user_loggedin_as.err);
                    }
                    else {
                        $(".registration_successful").html(`Logged in as ${selfserve.global.currentUser.username}`);
                    }
                });
            }
            else registrationFailed(r);
        });
    };
    selfserve.global.onLoad.push(() => selfserve.random_banner.setBannerWithGradient("./images/random/constellation_entity.jpg", { r: 255, g: 255, b: 255 }));
</script>

<div id="registration_container" style="padding: 1%;">
    <div class="registration_failed">
        Registration FAILED!<br><br>
        Cause: <div id="cause">

        </div>

        <br>
        <a href="javascript:void(0);" onclick="location.reload();">Go back</a>
    </div>

    <div class="registration_successful">
        <!--This message is inserted at runtime through JS-->
    </div>

    <form id="registration_form" action="javascript:validation();">
        <p>
            All below fields are required for registration.<br>
            Prior to registering, an administrator will need to verify your account.
        </p>

        E-Mail:<br>
        <input type="text" name="email" id="email_textbox"><br>
        Username:<br>
        <input type="text" name="username" id="username_textbox"><br>
        Password:<br>
        <input type="password" name="password" id="password_textbox"><br>
        <input type="submit" value="Register">
    </form>
</div>
    </div>
  </div>
</body>

</html>
